<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Traceway Logger - æ’ä»¶åŒ–ç¤ºä¾‹</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
    }
    h2 {
      color: #666;
      margin-top: 30px;
    }
    .section {
      background: #f5f5f5;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      border-left: 4px solid #4CAF50;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #45a049;
    }
    button.secondary {
      background: #2196F3;
    }
    button.secondary:hover {
      background: #0b7dda;
    }
    button.danger {
      background: #f44336;
    }
    button.danger:hover {
      background: #da190b;
    }
    .log-output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #4CAF50;
      padding-left: 10px;
    }
    .log-entry.error {
      border-left-color: #f44336;
      color: #ff6b6b;
    }
    .log-entry.warn {
      border-left-color: #ff9800;
      color: #ffa726;
    }
    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #2196F3;
      padding: 15px;
      margin: 15px 0;
      border-radius: 4px;
    }
    .code-block {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>ğŸ”Œ Traceway Logger æ’ä»¶åŒ–ç¤ºä¾‹</h1>
  
  <div class="info-box">
    <strong>ğŸ“š æœ¬ç¤ºä¾‹å±•ç¤ºï¼š</strong>
    <ul>
      <li>è‡ªå®šä¹‰ Integration æ’ä»¶ï¼ˆé¡µé¢å¯è§æ€§ç›‘å¬ï¼‰</li>
      <li>è‡ªå®šä¹‰ Transport æ’ä»¶ï¼ˆLocalStorage å­˜å‚¨ï¼‰</li>
      <li>æ’ä»¶çš„ç»„åˆä½¿ç”¨</li>
      <li>æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°å’Œ LocalStorage æŸ¥çœ‹æ•ˆæœ</li>
    </ul>
  </div>

  <div class="section">
    <h2>æ“ä½œé¢æ¿</h2>
    <div>
      <button onclick="logInfo()">è®°å½• Info æ—¥å¿—</button>
      <button onclick="logWarning()" class="secondary">è®°å½• Warning æ—¥å¿—</button>
      <button onclick="logError()" class="danger">è§¦å‘é”™è¯¯</button>
      <button onclick="testFetch()">æµ‹è¯• HTTP è¯·æ±‚</button>
      <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—æ˜¾ç¤º</button>
      <button onclick="showStorageLogs()">æŸ¥çœ‹ LocalStorage æ—¥å¿—</button>
    </div>
  </div>

  <div class="section">
    <h2>è‡ªå®šä¹‰æ’ä»¶è¯´æ˜</h2>
    
    <h3>1. VisibilityIntegrationï¼ˆè‡ªå®šä¹‰ Integrationï¼‰</h3>
    <div class="code-block">
class VisibilityIntegration implements Integration {
  setup(logger: Logger): void {
    document.addEventListener('visibilitychange', () => {
      logger.addBreadcrumb({
        type: 'custom',
        message: `visibility: ${document.visibilityState}`,
        data: { visibilityState: document.visibilityState },
      });
    });
  }
  teardown(): void {
    // æ¸…ç†èµ„æº
  }
}
    </div>
    <p><strong>åŠŸèƒ½ï¼š</strong>ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œè®°å½•ä¸º Breadcrumb</p>
    <p><strong>æµ‹è¯•ï¼š</strong>åˆ‡æ¢æµè§ˆå™¨æ ‡ç­¾é¡µï¼ŒæŸ¥çœ‹æ§åˆ¶å°çš„ Breadcrumb</p>

    <h3>2. LocalStorageTransportï¼ˆè‡ªå®šä¹‰ Transportï¼‰</h3>
    <div class="code-block">
class LocalStorageTransport implements Transport {
  send(events: LogEvent[]): void {
    const existing = localStorage.getItem('traceway_logs') || '[]';
    const logs = JSON.parse(existing);
    logs.push(...events);
    localStorage.setItem('traceway_logs', JSON.stringify(logs));
  }
}
    </div>
    <p><strong>åŠŸèƒ½ï¼š</strong>å°†æ—¥å¿—ä¿å­˜åˆ°æµè§ˆå™¨çš„ LocalStorage</p>
    <p><strong>æµ‹è¯•ï¼š</strong>ç‚¹å‡»"æŸ¥çœ‹ LocalStorage æ—¥å¿—"æŒ‰é’®æŸ¥çœ‹ä¿å­˜çš„æ—¥å¿—</p>
  </div>

  <div class="section">
    <h2>å®æ—¶æ—¥å¿—è¾“å‡º</h2>
    <div id="log-output" class="log-output">
      <div class="log-entry">ç­‰å¾…æ—¥å¿—è¾“å‡º...</div>
    </div>
  </div>

  <script type="module">
    import { 
      createLogger, 
      ConsoleTransport,
      BreadcrumbIntegration,
      ErrorsIntegration,
      UIIntegration,
      HttpIntegration
    } from '../../packages/logger/dist/index.mjs';

    // è‡ªå®šä¹‰ Integration: é¡µé¢å¯è§æ€§ç›‘å¬
    class VisibilityIntegration {
      setup(logger) {
        if (typeof document === 'undefined') return;
        
        this.onVisibilityChange = () => {
          logger.addBreadcrumb({
            type: 'custom',
            message: `visibility: ${document.visibilityState}`,
            data: { visibilityState: document.visibilityState },
          });
          
          // æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
          addLogToOutput(`ğŸ” Visibility changed: ${document.visibilityState}`, 'info');
        };
        
        document.addEventListener('visibilitychange', this.onVisibilityChange);
        // ç«‹å³è®°å½•å½“å‰çŠ¶æ€
        this.onVisibilityChange();
      }
      
      teardown() {
        if (this.onVisibilityChange) {
          document.removeEventListener('visibilitychange', this.onVisibilityChange);
        }
      }
    }

    // è‡ªå®šä¹‰ Transport: LocalStorage å­˜å‚¨
    class LocalStorageTransport {
      constructor(options = {}) {
        this.options = {
          key: options.key || 'traceway_logs',
          maxSize: options.maxSize || 1000,
        };
      }
      
      send(events) {
        if (typeof localStorage === 'undefined') {
          return;
        }
        
        try {
          const existing = localStorage.getItem(this.options.key);
          const logs = existing ? JSON.parse(existing) : [];
          
          // æ·»åŠ æ–°äº‹ä»¶
          logs.push(...events);
          
          // é™åˆ¶å¤§å°ï¼Œä¿ç•™æœ€æ–°çš„
          if (logs.length > this.options.maxSize) {
            logs.splice(0, logs.length - this.options.maxSize);
          }
          
          // ä¿å­˜å›å­˜å‚¨
          localStorage.setItem(this.options.key, JSON.stringify(logs));
          
          addLogToOutput(`ğŸ’¾ Saved ${events.length} event(s) to LocalStorage`, 'info');
        } catch (error) {
          console.warn('[Traceway] LocalStorage transport failed:', error);
          addLogToOutput(`âŒ LocalStorage save failed: ${error.message}`, 'error');
        }
      }
    }

    // åˆ›å»º Loggerï¼Œä½¿ç”¨è‡ªå®šä¹‰æ’ä»¶
    const logger = createLogger({
      app: 'plugin-example',
      env: 'development',
      release: '1.0.0',
      level: 'debug',
      transports: [
        new ConsoleTransport(),           // æ§åˆ¶å°è¾“å‡º
        new LocalStorageTransport({        // è‡ªå®šä¹‰ Transport
          key: 'traceway_logs',
          maxSize: 500,
        }),
      ],
      integrations: [
        new BreadcrumbIntegration({ maxBreadcrumbs: 50 }),
        new ErrorsIntegration(),
        new VisibilityIntegration(),      // è‡ªå®šä¹‰ Integration
        new UIIntegration(),
        new HttpIntegration(),
      ],
    });

    // æ‹¦æˆª ConsoleTransport çš„è¾“å‡ºï¼Œæ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
    const originalConsole = {
      log: console.log,
      info: console.info,
      warn: console.warn,
      error: console.error,
    };

    // é‡å†™ console æ–¹æ³•ä»¥æ•è·æ—¥å¿—
    console.log = function(...args) {
      originalConsole.log.apply(console, args);
      if (args[0] && typeof args[0] === 'string' && args[0].includes('[')) {
        addLogToOutput(args.join(' '), 'info');
      }
    };

    console.info = function(...args) {
      originalConsole.info.apply(console, args);
      if (args[0] && typeof args[0] === 'string' && args[0].includes('[')) {
        addLogToOutput(args.join(' '), 'info');
      }
    };

    console.warn = function(...args) {
      originalConsole.warn.apply(console, args);
      if (args[0] && typeof args[0] === 'string' && args[0].includes('[')) {
        addLogToOutput(args.join(' '), 'warn');
      }
    };

    console.error = function(...args) {
      originalConsole.error.apply(console, args);
      if (args[0] && typeof args[0] === 'string' && args[0].includes('[')) {
        addLogToOutput(args.join(' '), 'error');
      }
    };

    // é¡µé¢æ—¥å¿—è¾“å‡ºå‡½æ•°
    function addLogToOutput(message, level = 'info') {
      const output = document.getElementById('log-output');
      const entry = document.createElement('div');
      entry.className = `log-entry ${level}`;
      
      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;
      
      output.insertBefore(entry, output.firstChild);
      
      // é™åˆ¶æ˜¾ç¤ºæ•°é‡
      while (output.children.length > 50) {
        output.removeChild(output.lastChild);
      }
    }

    // å…¨å±€å‡½æ•°ä¾›æŒ‰é’®è°ƒç”¨
    window.logInfo = () => {
      logger.info('manual_info', 'Manual info log triggered', { 
        timestamp: Date.now(),
        source: 'button',
      });
      addLogToOutput('âœ… Info log recorded', 'info');
    };

    window.logWarning = () => {
      logger.warn('manual_warning', 'Manual warning log triggered', {
        timestamp: Date.now(),
        source: 'button',
      });
      addLogToOutput('âš ï¸ Warning log recorded', 'warn');
    };

    window.logError = () => {
      logger.error('manual_error', 'Manual error log triggered', {
        timestamp: Date.now(),
        source: 'button',
      });
      addLogToOutput('âŒ Error log recorded', 'error');
      
      // è§¦å‘ä¸€ä¸ªæœªæ•è·çš„é”™è¯¯æ¥æµ‹è¯• ErrorsIntegration
      setTimeout(() => {
        throw new Error('This is a test error from plugin example');
      }, 100);
    };

    window.testFetch = async () => {
      addLogToOutput('ğŸŒ Testing HTTP request...', 'info');
      try {
        const response = await fetch('https://api.github.com/users/octocat');
        const data = await response.json();
        logger.info('api_success', 'GitHub API success', { 
          login: data.login,
          url: data.html_url,
        });
        addLogToOutput(`âœ… HTTP request successful: ${data.login}`, 'info');
      } catch (error) {
        logger.error('api_error', 'GitHub API error', { 
          error: error.message,
        });
        addLogToOutput(`âŒ HTTP request failed: ${error.message}`, 'error');
      }
    };

    window.clearLogs = () => {
      const output = document.getElementById('log-output');
      output.innerHTML = '<div class="log-entry">æ—¥å¿—å·²æ¸…ç©º...</div>';
    };

    window.showStorageLogs = () => {
      try {
        const logs = localStorage.getItem('traceway_logs');
        if (logs) {
          const parsedLogs = JSON.parse(logs);
          console.log('ğŸ“¦ LocalStorage logs:', parsedLogs);
          addLogToOutput(`ğŸ“¦ Found ${parsedLogs.length} log(s) in LocalStorage`, 'info');
          addLogToOutput('æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°ä»¥æŸ¥çœ‹å®Œæ•´æ—¥å¿—æ•°æ®', 'info');
        } else {
          addLogToOutput('ğŸ“¦ No logs in LocalStorage yet', 'info');
        }
      } catch (error) {
        addLogToOutput(`âŒ Failed to read LocalStorage: ${error.message}`, 'error');
      }
    };

    // åˆå§‹åŒ–
    logger.setUser({ id: 'demo-user', name: 'Demo User', email: 'demo@example.com' });
    logger.info('app_start', 'Plugin example app started');
    addLogToOutput('ğŸš€ Plugin example initialized', 'info');
    addLogToOutput('ğŸ’¡ Try switching browser tabs to test VisibilityIntegration', 'info');
  </script>
</body>
</html>

